# 시스템 아키텍처

## 1. 전체 구조도

```
┌─────────────────────────────────────────────────────────────────┐
│                         사용자                                   │
└─────────────────────────────────────────────────────────────────┘
          │                                    │
          │ 메모 던지기                         │ 검색/조회
          ▼                                    ▼
┌─────────────────────┐              ┌─────────────────────┐
│   카카오톡 채널      │              │     PlayMCP         │
│   "메모봇"          │              │   (AI 대화)         │
└─────────────────────┘              └─────────────────────┘
          │                                    │
          │ 스킬 요청                          │ MCP 호출
          ▼                                    ▼
┌─────────────────────┐              ┌─────────────────────┐
│   카카오 챗봇 엔진   │              │    MCP 서버         │
│   (카카오 i 빌더)   │              │   (Streamable HTTP) │
└─────────────────────┘              └─────────────────────┘
          │                                    │
          │ HTTP POST                          │
          ▼                                    ▼
┌─────────────────────────────────────────────────────────────────┐
│                      스킬서버 (FastAPI)                          │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐  │
│  │ 메시지 수신  │  │ AI 분류     │  │ 나에게 보내기           │  │
│  │ /skill      │  │ (Kanana)   │  │ (카카오 API)            │  │
│  └─────────────┘  └─────────────┘  └─────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │    Database     │
                    │  (SQLite/Supa)  │
                    └─────────────────┘
```

---

## 2. 메모 저장 플로우

```
[1] 사용자가 카카오 채널 "메모봇"에 메시지 전송
    예: "https://youtube.com/watch?v=abc123"
         ↓
[2] 카카오 챗봇 엔진이 스킬서버 호출 (HTTP POST)
    POST /skill
    Body: { userRequest: { utterance: "https://..." } }
         ↓
[3] 스킬서버가 메시지 분석
    - URL 감지 (유튜브, 블로그, 쇼핑몰 등)
    - Kanana API로 카테고리/태그/요약 생성
         ↓
[4] DB에 저장
    - user_id, content, category, tags, summary, created_at
         ↓
[5] 나에게 보내기 API 호출
    POST /v2/api/talk/memo/default/send
    → 사용자의 "나와의 채팅방"에 정리본 전송
         ↓
[6] 챗봇 응답 반환
    "📌 영상 저장완료! [요약: ...]"
```

---

## 3. 메모 검색 플로우 (PlayMCP)

```
[1] 사용자가 PlayMCP에서 질문
    "저번에 저장한 맛집 뭐였지?"
         ↓
[2] PlayMCP가 MCP 서버 호출
    POST /mcp
    { method: "tools/call", params: { name: "search_memo", arguments: { query: "맛집" } } }
         ↓
[3] MCP 서버가 DB 검색
    SELECT * FROM memos WHERE category = '맛집' OR tags LIKE '%맛집%'
         ↓
[4] 결과 반환
    { content: [{ type: "text", text: "맛집 메모 3건:\n1. 강남 파스타집..." }] }
```

---

## 4. 컴포넌트 상세

### 4.1 카카오 채널 챗봇
| 항목 | 설명 |
|------|------|
| 역할 | 사용자 메시지 수집 |
| 플랫폼 | 카카오 i 빌더 |
| 비용 | 무료 |
| 설정 | 폴백 블록 → 스킬서버 연결 |

### 4.2 스킬서버
| 항목 | 설명 |
|------|------|
| 역할 | 메시지 처리, AI 분류, 저장, 알림 |
| 프레임워크 | FastAPI (Python) |
| 호스팅 | Vercel Serverless |
| 엔드포인트 | POST /skill |

### 4.3 MCP 서버
| 항목 | 설명 |
|------|------|
| 역할 | PlayMCP 연동, 메모 검색/조회 |
| 프레임워크 | FastAPI (Python) |
| 호스팅 | Vercel Serverless |
| 프로토콜 | Streamable HTTP (JSON-RPC 2.0) |
| 엔드포인트 | POST /mcp |

### 4.4 Database
| 항목 | 설명 |
|------|------|
| MVP | SQLite (파일 기반) |
| 확장 | Supabase (PostgreSQL) |
| 테이블 | memos, users |

---

## 5. 기술 스택 요약

```
┌─────────────────────────────────────────────┐
│              Frontend (없음)                 │
│         사용자는 카카오톡만 사용              │
└─────────────────────────────────────────────┘
                      │
┌─────────────────────────────────────────────┐
│              Backend                         │
│  ┌─────────────┐  ┌─────────────────────┐   │
│  │  FastAPI    │  │  Vercel Serverless  │   │
│  │  Python 3.9+│  │  Edge Functions     │   │
│  └─────────────┘  └─────────────────────┘   │
└─────────────────────────────────────────────┘
                      │
┌─────────────────────────────────────────────┐
│              External APIs                   │
│  ┌─────────────┐  ┌─────────────────────┐   │
│  │ Kanana API  │  │ 카카오 API          │   │
│  │ (AI 분류)   │  │ (나에게 보내기)      │   │
│  └─────────────┘  └─────────────────────┘   │
└─────────────────────────────────────────────┘
                      │
┌─────────────────────────────────────────────┐
│              Database                        │
│  ┌─────────────────────────────────────┐    │
│  │  SQLite (MVP) → Supabase (확장)     │    │
│  └─────────────────────────────────────┘    │
└─────────────────────────────────────────────┘
```

---

## 6. 배포 구조

```
GitHub Repository
       │
       ├── /api
       │    ├── skill.py      ← 스킬서버 (챗봇용)
       │    └── mcp.py        ← MCP 서버 (PlayMCP용)
       │
       ├── /lib
       │    ├── db.py         ← DB 연결
       │    ├── kanana.py     ← Kanana API 클라이언트
       │    └── kakao.py      ← 카카오 API 클라이언트
       │
       ├── vercel.json
       └── requirements.txt
              │
              ▼
         Vercel 배포
              │
              ├── https://memomate.vercel.app/skill  ← 챗봇 스킬
              └── https://memomate.vercel.app/mcp    ← PlayMCP
```

---

## 7. 보안 고려사항

| 항목 | 대응 |
|------|------|
| 사용자 인증 | 카카오 OAuth (PlayMCP Gateway) |
| API 키 보호 | 환경 변수 (Vercel Secrets) |
| 데이터 격리 | user_id 기반 필터링 |
| HTTPS | Vercel 자동 제공 |

---

## 8. 다음 문서

- [02_카카오_채널_챗봇.md](./02_카카오_채널_챗봇.md) - 챗봇 설정 상세
- [03_스킬서버_설계.md](./03_스킬서버_설계.md) - 스킬서버 구현
