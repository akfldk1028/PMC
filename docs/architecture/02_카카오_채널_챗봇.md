# 카카오 채널 챗봇 설정

## 1. 개요

카카오 채널 챗봇을 통해 사용자 메시지를 수신하고, 스킬서버로 전달합니다.

```
사용자 → 카카오 채널 → 챗봇 엔진 → 스킬서버
```

---

## 2. 설정 단계

### Step 1: 카카오 비즈니스 채널 생성

1. [카카오톡 채널 관리자센터](https://center-pf.kakao.com/) 접속
2. 카카오 계정 로그인
3. **새 채널 만들기**
4. 채널 정보 입력:
   - 채널명: `챗노트` (또는 원하는 이름)
   - 검색용 아이디: `memomate`
   - 카테고리: `IT/테크`
5. 채널 생성 완료

### Step 2: 카카오 i 빌더에서 챗봇 생성

1. [카카오 i 오픈빌더](https://i.kakao.com/) 접속
2. **새로운 봇 생성**
3. 봇 이름: `챗노트봇`
4. 마스터 권한 설정

### Step 3: 스킬 서버 등록

1. 좌측 메뉴 → **스킬**
2. **스킬 생성**
3. 스킬 정보 입력:
   - 스킬명: `메모 저장 스킬`
   - 설명: `사용자 메모를 저장하고 정리합니다`
   - URL: `https://your-domain.vercel.app/skill`
   - Method: `POST`

### Step 4: 폴백 블록에 스킬 연결

1. 좌측 메뉴 → **시나리오** → **폴백 블록**
2. 폴백 블록 = 매칭되는 블록이 없을 때 실행 (모든 메시지 수신)
3. **파라미터 설정**:
   - 파라미터명: `utterance`
   - 엔티티: `@sys.text` (전체 텍스트)
4. **스킬 연결**: 위에서 만든 스킬 선택
5. 저장

### Step 5: 채널과 챗봇 연결

1. 좌측 메뉴 → **설정** → **채널 연결**
2. Step 1에서 만든 채널 선택
3. 연결 완료

### Step 6: 배포

1. 우측 상단 → **배포**
2. 배포 완료 후 채널에서 테스트

---

## 3. 스킬 요청 형식

카카오 챗봇이 스킬서버에 보내는 요청:

```json
{
  "intent": {
    "id": "fallback",
    "name": "폴백 블록"
  },
  "userRequest": {
    "timezone": "Asia/Seoul",
    "params": {
      "ignoreMe": "true"
    },
    "block": {
      "id": "fallback",
      "name": "폴백 블록"
    },
    "utterance": "https://youtube.com/watch?v=abc123",
    "lang": "ko",
    "user": {
      "id": "user_unique_id",
      "type": "botUserKey",
      "properties": {}
    }
  },
  "bot": {
    "id": "bot_id",
    "name": "챗노트봇"
  },
  "action": {
    "name": "메모 저장 스킬",
    "clientExtra": null,
    "params": {},
    "id": "action_id",
    "detailParams": {}
  }
}
```

### 핵심 필드

| 필드 | 설명 |
|------|------|
| `userRequest.utterance` | **사용자가 보낸 메시지** (핵심!) |
| `userRequest.user.id` | 사용자 고유 ID |
| `action.name` | 호출된 스킬 이름 |

---

## 4. 스킬 응답 형식

스킬서버가 챗봇에 반환하는 응답:

### 4.1 단순 텍스트 응답

```json
{
  "version": "2.0",
  "template": {
    "outputs": [
      {
        "simpleText": {
          "text": "📌 메모가 저장되었습니다!\n\n📂 카테고리: 영상\n🏷️ 태그: #유튜브 #개발\n📝 요약: 프로그래밍 강의 영상"
        }
      }
    ]
  }
}
```

### 4.2 카드형 응답 (선택)

```json
{
  "version": "2.0",
  "template": {
    "outputs": [
      {
        "basicCard": {
          "title": "📌 메모 저장 완료",
          "description": "카테고리: 영상\n태그: #유튜브 #개발",
          "thumbnail": {
            "imageUrl": "https://example.com/thumb.jpg"
          },
          "buttons": [
            {
              "action": "message",
              "label": "전체 메모 보기",
              "messageText": "전체 메모 보기"
            }
          ]
        }
      }
    ]
  }
}
```

### 4.3 에러 응답

```json
{
  "version": "2.0",
  "template": {
    "outputs": [
      {
        "simpleText": {
          "text": "❌ 저장에 실패했습니다. 다시 시도해주세요."
        }
      }
    ]
  }
}
```

---

## 5. 특수 명령어 처리

사용자가 보내는 특수 명령어도 처리:

| 명령어 | 동작 |
|--------|------|
| `정리해줘` | 오늘 저장한 메모 요약 |
| `이번주 정리` | 이번주 메모 카테고리별 정리 |
| `맛집 보여줘` | 맛집 카테고리 메모 목록 |
| `검색 OOO` | 키워드로 메모 검색 |

스킬서버에서 `utterance` 분석 후 분기 처리:

```python
utterance = request["userRequest"]["utterance"]

if "정리" in utterance:
    # 정리 로직
elif "검색" in utterance:
    # 검색 로직
else:
    # 일반 메모 저장
```

---

## 6. 주의사항

### 응답 시간 제한
- 카카오 챗봇은 **5초 이내** 응답 필요
- 초과 시 타임아웃 에러

### 해결책: 비동기 처리
1. 빠르게 "저장 중..." 응답 반환
2. 백그라운드에서 AI 분류 처리
3. 나에게 보내기 API로 결과 전송

```python
@app.post("/skill")
async def skill_handler(request: Request):
    # 1. 즉시 응답
    response = {"version": "2.0", "template": {"outputs": [{"simpleText": {"text": "📌 저장 중..."}}]}}

    # 2. 백그라운드 처리 (별도 태스크)
    background_tasks.add_task(process_memo, request_data)

    return response
```

---

## 7. 테스트 방법

1. 카카오톡에서 채널 검색 (예: `챗노트`)
2. 채널 추가
3. 아무 메시지 전송
4. 스킬서버 로그 확인
5. 응답 확인

---

## 8. 다음 문서

- [03_스킬서버_설계.md](./03_스킬서버_설계.md) - 스킬서버 구현 상세
