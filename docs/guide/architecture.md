# 챗노트 아키텍처 가이드

## 핵심 개념: 3가지는 뭐가 다른가?

```
┌─────────────────────────────────────────────────────────────┐
│                      Vercel (호스팅)                         │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────┐  │
│  │  /skill         │  │  /mcp           │  │  /api/cron  │  │
│  │  (카카오 스킬)    │  │  (MCP 서버)     │  │  (크론잡)    │  │
│  │  skill.py       │  │  mcp_server.py  │  │  cron.py    │  │
│  └────────┬────────┘  └────────┬────────┘  └──────┬──────┘  │
│           │                    │                   │         │
│           └────────────┬───────┴───────────────────┘         │
│                        ▼                                     │
│              ┌─────────────────────┐                         │
│              │    lib/ (공유 모듈)   │                         │
│              │  - redis_db.py      │                         │
│              │  - classifier.py    │                         │
│              │  - memo_service.py  │                         │
│              └─────────┬───────────┘                         │
│                        ▼                                     │
│              ┌─────────────────────┐                         │
│              │   Upstash Redis     │                         │
│              │   (데이터베이스)      │                         │
│              └─────────────────────┘                         │
└─────────────────────────────────────────────────────────────┘
         ▲                              ▲
         │                              │
┌────────┴────────┐           ┌────────┴────────┐
│  카카오 오픈빌더  │           │    PlayMCP      │
│  (챗봇 플랫폼)   │           │  (MCP 마켓)     │
└────────┬────────┘           └────────┬────────┘
         ▲                              ▲
         │                              │
┌────────┴────────┐           ┌────────┴────────┐
│   카카오톡 유저   │           │   Claude AI     │
│   (채팅으로 메모) │           │   (도구로 메모)  │
└─────────────────┘           └─────────────────┘
```

---

## 각 컴포넌트 역할

### 1. Vercel (호스팅 플랫폼)
- **역할**: 코드를 서버리스로 배포
- **URL**: `https://memomate-mcp.vercel.app`
- **빌드 명령어**: `vercel --prod`

### 2. 카카오 스킬 서버 (`/skill`)
- **파일**: `api/skill.py`
- **호출자**: 카카오 오픈빌더 → 카카오톡 유저
- **기능**: 채팅 메시지 → AI 의도 분류 → 메모 저장/검색/삭제

### 3. MCP 서버 (`/mcp`)
- **파일**: `api/mcp_server.py`
- **호출자**: PlayMCP → Claude AI
- **기능**: Claude가 도구로 메모 저장/검색/삭제
- **프로토콜**: JSON-RPC 2.0

### 4. 크론잡 (`/api/cron/reminders`)
- **파일**: `api/cron.py`
- **호출자**: Vercel Cron (매일 09:00)
- **기능**: 리마인더 알림 발송

---

## 언제 빌드/배포해야 하나?

### 빌드 필요 (vercel --prod)

| 상황 | 명령어 |
|------|--------|
| Python 코드 수정 (`api/*.py`, `lib/*.py`) | `vercel --prod` |
| `vercel.json` 수정 | `vercel --prod` |
| `requirements.txt` 수정 | `vercel --prod` |

### 빌드 + 추가 작업

| 상황 | 작업 |
|------|------|
| 환경변수 추가/변경 | Vercel 대시보드 → 환경변수 추가 → `vercel --prod` |
| MCP 도구 추가/변경 | `vercel --prod` → PlayMCP에서 재등록 |
| 카카오 응답 형식 변경 | `vercel --prod` → (오픈빌더 수정 불필요) |

### 빌드 불필요

| 상황 | 이유 |
|------|------|
| 카카오 오픈빌더 시나리오 수정 | 카카오 설정일 뿐, 우리 코드 아님 |
| PlayMCP에서 앱 설명 수정 | PlayMCP 설정일 뿐 |
| Redis 데이터 조회/수정 | 런타임 데이터, 코드 아님 |

---

## 배포 플로우

```
코드 수정
    │
    ▼
vercel --prod
    │
    ▼
┌───────────────────────────────────┐
│ Vercel이 자동으로:                 │
│ 1. requirements.txt 설치          │
│ 2. api/*.py를 서버리스 함수로 빌드  │
│ 3. 새 URL 생성 및 라우팅           │
└───────────────────────────────────┘
    │
    ▼
배포 완료! (MCP, Skill 둘 다 업데이트됨)
```

---

## 환경변수 목록

| 변수명 | 용도 | 필수 |
|--------|------|------|
| `UPSTASH_REDIS_REST_URL` | Redis 데이터베이스 URL | ✅ |
| `UPSTASH_REDIS_REST_TOKEN` | Redis 인증 토큰 | ✅ |
| `OPENAI_API_KEY` | AI 의도 분류 | ✅ |
| `KAKAO_REST_API_KEY` | 카카오 API (나에게 보내기) | ⚪ 선택 |

---

## 엔드포인트 정리

| 경로 | 파일 | 용도 |
|------|------|------|
| `/skill` | `api/skill.py` | 카카오 챗봇 스킬 |
| `/mcp` | `api/mcp_server.py` | PlayMCP용 MCP 서버 |
| `/seed` | `api/mcp_server.py` | 테스트 데이터 생성 |
| `/api/cron/reminders` | `api/cron.py` | 리마인더 크론 |
| `/api/cron/health` | `api/cron.py` | 헬스체크 |

---

## 요약

1. **Vercel** = 호스팅 플랫폼 (모든 코드가 여기 배포됨)
2. **MCP 서버** = Vercel의 `/mcp` 엔드포인트 (Claude가 사용)
3. **카카오 스킬** = Vercel의 `/skill` 엔드포인트 (카카오톡이 사용)

**코드 바꾸면 → `vercel --prod` 한 번이면 MCP, 카카오 둘 다 업데이트!**
